---
title: "p8105_hw6_zlb2008"
author: "Zakari L. Billo"
date: "2025-12-03"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(broom)
library(purrr)
library(p8105.datasets)
library(patchwork)

knitr::opts_chunk$set(
  fig.width = 8,
  fig.height = 7,
  fig.align = "center",
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1 

```{r}
homicide_df <- read.csv('data/homicide-data.csv', na = c("NA", ".", "")) |>
  janitor::clean_names() |>
  mutate(
    city_state = str_c(city, ", ", state)
  ) |>
  filter(
    !city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"),
    victim_race %in% c("White", "Black")
  ) |>
  mutate(
    victim_age = as.numeric(victim_age),
    case_outcome = ifelse(disposition == "Closed by arrest", 1, 0)
  ) |>
  filter(!is.na(victim_age)) |>
  select(city_state, case_outcome, victim_age, victim_sex, victim_race)
```

glm for Baltimore, MD

```{r}
bmore_results <-
  homicide_df |> 
  filter(city_state == "Baltimore, MD") |> 
  glm(
    case_outcome ~ victim_age + victim_sex + victim_race,
    family = binomial(),
    data = _
  ) |> 
  broom::tidy(conf.int = TRUE) |> 
  mutate(
    OR = exp(estimate),
    CL_low = exp(conf.low),
    CL_high = exp(conf.high)
  ) |>
  filter(term == "victim_sexMale") |>
  select(term, log_OR = estimate, OR, CL_low, CL_high, p.value)

bmore_results |> knitr::kable(digits = 3)
```
The odds ratio for solved homocides among male victims compared to that among female victims in Baltimore, MD is 0.426 (95% CI: 0.324, 0.558), adjusting for victim age and race.

```{r}
city_results <-
  homicide_df |> 
  nest(data = -city_state) |> 
  mutate(
    fit = map(
      data,
      ~ glm(case_outcome ~ victim_age + victim_sex + victim_race,
            family = binomial(), data = .x)
    ),
    tidy_fit = map(fit, ~ broom::tidy(.x, conf.int = TRUE))
  ) |>
  unnest(tidy_fit) |>
  filter(term == "victim_sexMale") |>
  mutate(
    OR = exp(estimate),
    CL_low = exp(conf.low),
    CL_high = exp(conf.high)
  ) |>
  select(city_state, OR, CL_low, CL_high, p.value)

city_results |> 
  knitr::kable(digits = 3)
```
plot the ORs 

```{r}
city_results |>
  mutate(city_state = fct_reorder(city_state, OR)) |>
  ggplot(aes(y = city_state, x = OR)) +
  geom_point(size = 2) +
  geom_errorbarh(aes(xmin = CL_low, xmax = CL_high), height = 0.15) +
  geom_vline(xintercept = 1, color = "red", linetype = "dotted") +
  labs(
    title = "Adjusted Odds Ratio for Solved Homicides: Male vs Female Victims",
    x = "Odds Ratio (adjusted for age & race)",
    y = "City"
  ) +
  theme_minimal()
```

The plot of ORs by city shows that most cities have a lower odds of solving homicide cases for male victims compared to female victims. 

Albuquerque, NM; Stockton, CA; and Fresno, CA are the exception given that they have the highest estimated odds ratios, meaning that homicides with male victim are more likely to be solved than homicides with female victims. However, most of these cities' estimated ORs have confidence intervals that include the null, implying there is no statistically significant evidence of a difference in the odds of solving homicides between male and female victims.

New York, NY; Baton Rouge, LA; and Omaha, NE have the lowest odds of solving homicide cases for male victims compared to female victims. The OR confidence intervals for these cities is below 1, providing statistically significant evidence for lower solve rates among male-victim cases.

## Problem 2 

```{r}
data("weather_df")
set.seed(1)

bootstrap_results <-
  weather_df |>
  modelr::bootstrap(n = 5000) |>
  mutate(
    models = map(strap, \(df) lm(tmax ~ tmin + prcp, data = df)),
    results_glance = map(models, broom::glance),
    results_tidy = map(models, broom::tidy)
  ) |>
  select(-strap, -models) |>
  unnest(results_glance) |>
  select(.id, r.squared, results_tidy) |>
  unnest(results_tidy) |>
  select(.id, r.squared, term, estimate) |>
  pivot_wider(
    names_from = term,
    values_from = estimate
  ) |>
  mutate(
    beta_ratio = tmin / prcp
  )
```

make plots

```{r}
p1 <- bootstrap_results |>
  ggplot(aes(x = r.squared)) +
  geom_density(fill = "violet", alpha = 0.5) +
  labs(title = "Bootstrap Distribution of R^2", x = "RÂ²")

p2 <- bootstrap_results |>
  ggplot(aes(x = beta_ratio)) +
  geom_density(fill = "green", alpha = 0.5) +
  labs(title = "Distribution of Beta_1/Beta_2", x = "Coefficient Ratio")

p1 + p2
```

make table 

```{r}
ci_results <- 
  bootstrap_results |>
  summarize(
    R_sq_low = quantile(r.squared, 0.025),
    R_sq_high = quantile(r.squared, 0.975),
    beta_ratio_low = quantile(beta_ratio, 0.025),
    beta_ratio_high = quantile(beta_ratio, 0.975)
  )

knitr::kable(ci_results, digits = 3)
```

## Problem 3